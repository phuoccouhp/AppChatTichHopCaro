# ?? ??????? - ??? Outbound ??

## ????
- ? Client ???? Server
- ? Server ?????
- ? **Server ?????** (??)
- ? Windows ????? Outbound ??

## ????
Windows Firewall ?????? Outbound TCP ???????????????

???? **????**?
1. **Inbound**: ?? Client ????
2. **Outbound** (??): ?? Server ????

## ?? ????

### ?? 1: ????????

**Server ??? Admin ?????**

```
1. ???? CMD/PowerShell
2. ?? "????????"
3. ?? Server ??
4. Server ?????????????
```

Server ????
```
[OpenPortAsAdmin] Launching PowerShell: C:\Users\...\firewall_8e526c20.ps1
[OpenPortAsAdmin] PowerShell exit code: 0
[OpenPortAsAdmin] Waiting 3 seconds for Windows Firewall to sync...
? Firewall port 9000 successfully opened and verified!
```

---

### ?? 2: ?????????

?? Server ? Admin ????????????

#### ?? A: ?? OpenFirewall.bat (??)
```cmd
# ???? OpenFirewall.bat -> ????????
.\OpenFirewall.bat
```

#### ?? B: ?? PowerShell ????
```powershell
# ???????? PowerShell??????

# ?????
Remove-NetFirewallRule -DisplayName "ChatAppServer" -ErrorAction SilentlyContinue
Remove-NetFirewallRule -DisplayName "ChatAppServer (Out)" -ErrorAction SilentlyContinue

# ?? Inbound ??
New-NetFirewallRule -DisplayName "ChatAppServer" `
    -Direction Inbound `
    -Action Allow `
    -Protocol TCP `
    -LocalPort 9000 `
    -Profile Domain,Private,Public `
    -Enabled $true

# ?? Outbound ?? (??!)
New-NetFirewallRule -DisplayName "ChatAppServer (Out)" `
    -Direction Outbound `
    -Action Allow `
    -Protocol TCP `
    -LocalPort 9000 `
    -RemoteAddress Any `
    -Profile Domain,Private,Public `
    -Enabled $true

# ??
Get-NetFirewallRule -DisplayName "ChatAppServer*" | Format-Table DisplayName, Direction, Action, Enabled
```

#### ?? C: ?? netsh ??
```cmd
# ???????? CMD??????

netsh advfirewall firewall add rule name="ChatAppServer" dir=in action=allow protocol=TCP localport=9000 profile=domain,private,public enable=yes

netsh advfirewall firewall add rule name="ChatAppServer (Out)" dir=out action=allow protocol=TCP localport=9000 remoteip=any profile=domain,private,public enable=yes

# ??
netsh advfirewall firewall show rule name="ChatAppServer"
netsh advfirewall firewall show rule name="ChatAppServer (Out)"
```

---

## ? ???????

### ?? 1: ?? Windows Defender ???????
```
1. ? Windows ? + ?? "???" ? "Windows Defender ???"
2. ?? "????"
3. ??? "????" ? "????"
4. ?????? "ChatAppServer" ? "ChatAppServer (Out)"
5. ?? Status = "???"
```

### ?? 2: ?? PowerShell
```powershell
# ????
Get-NetFirewallRule -DisplayName "ChatAppServer*" | 
    Select DisplayName, Direction, Action, Enabled | 
    Format-Table -AutoSize

# ?????
# DisplayName              Direction Action Enabled
# -----------              --------- ------ -------
# ChatAppServer            Inbound   Allow True
# ChatAppServer (Out)      Outbound  Allow True
```

### ?? 3: ??????
```cmd
.\DebugFirewallRules.ps1
```

---

## ?? ????

1. **Server ?** (? Admin ??):
```
dotnet run --project ChatAppServer/ChatAppServer.csproj
```

?????
```
[CONNECT] New client connected: 192.168.x.x:xxxxx
[LOGIN] User 'username' logged in from IP: 192.168.x.x
Server ????? 9000
```

2. **Client ?** (????):
```
# ? Client ??? Server IP
192.168.x.x ? 10.x.x.x (?????)
??: 9000
```

???
- ? ????
- ? ????
- ? **?? Server ?????** (???????)

---

## ?? ????????

### ????

1. **Server ??? Admin ?????**
   ```
   # ???? CMD/PowerShell -> "????????"
   ```

2. **??????????????**
   ```powershell
   Get-NetFirewallRule -DisplayName "ChatAppServer*"
   ```

3. **????? Profile ??????**
   - Domain ?
   - Private ?  
   - Public ?

4. **Outbound ??? RemoteAddress ??? "Any"?**
   ```powershell
   Get-NetFirewallRule -DisplayName "ChatAppServer (Out)" | 
       Get-NetFirewallAddressFilter
   ```
   ???? `RemoteAddress : Any`

5. **Port 9000 ??????????**
   ```cmd
   netstat -ano | findstr :9000
   ```

6. **Client ????????**
   - ?? Ping:
   ```cmd
   ping [Server-IP]
   ```

### ?????????

| ?? | ?? | ?? |
|------|------|------|
| PowerShell exit code: 1 | ???? | ? Admin ?? |
| "No rules match..." | ????? | ?????? Admin ?? |
| Timeout (10?) | Server ???? | ?? Outbound ?? |
| Connection refused | Server ??? | ?? Server: `dotnet run` |
| "Cannot connect" | ???/???? | Ping Server IP ???? |

---

## ?? ????

- `OpenFirewall.bat` - ????????? (? Admin)
- `DebugFirewallRules.ps1` - ??????????
- `TestPowerShellFirewall.bat` - ?? PowerShell ????
- `CheckFirewallRuleDetails.bat` - ????????

---

## ?? ????

```bash
# 1. ? Admin ?? CMD/PowerShell
# 2. ???????
.\OpenFirewall.bat

# 3. ?? Server
cd ChatAppServer
dotnet run

# 4. ???????? Client
cd ChatAppClient
dotnet run

# 5. ???Server IP + Port 9000
```

---

## ?? ????

?????????????
1. Server ???????? (?? [OpenPortAsAdmin] ??)
2. `Get-NetFirewallRule -DisplayName "ChatAppServer*"` ???
3. Client ????????

#pragma warning disable SYSLIB0011 
using ChatApp.Shared;
using ChatAppClient.Helpers;
using System;
using System.IO;
using System.Net.Sockets;
using System.Runtime.Serialization.Formatters.Binary;
using System.Threading;
using System.Threading.Tasks;
using System.Windows.Forms;

namespace ChatAppClient.Forms
{
    public class NetworkManager
    {
        #region Singleton
        private static NetworkManager? _instance;
        public static NetworkManager Instance => _instance ??= new NetworkManager();
        #endregion

        private TcpClient? _client;
        private NetworkStream? _stream;
        private BinaryFormatter _formatter;
        private frmHome? _homeForm;

        public string? UserID { get; private set; }
        public string? UserName { get; private set; }

        public string? CurrentServerIP { get; private set; }
        public int CurrentServerPort { get; private set; } = 9000;

        private TaskCompletionSource<LoginResultPacket>? _loginCompletionSource;
        private TaskCompletionSource<RegisterResultPacket>? _registerCompletionSource;
        private TaskCompletionSource<ChatHistoryResponsePacket>? _chatHistoryCompletionSource;

        public event Action<ForgotPasswordResultPacket>? OnForgotPasswordResult;
        public event Action<ChatHistoryResponsePacket>? OnChatHistoryReceived;

        private CancellationTokenSource? _listeningCts;
        private readonly object _loginLock = new object();

        private Queue<UserStatusPacket> _pendingStatusPackets = new Queue<UserStatusPacket>();

        private NetworkManager()
        {
            _formatter = new BinaryFormatter();
        }

        public void RegisterHomeForm(frmHome homeForm)
        {
            _homeForm = homeForm;
            Logger.Info("[Client] Home form registered, processing pending packets");
            // Process any pending status packets
            while (_pendingStatusPackets.Count > 0)
            {
                var packet = _pendingStatusPackets.Dequeue();
                if (_homeForm != null && !_homeForm.IsDisposed)
                {
                    _homeForm.BeginInvoke(new Action(() => _homeForm.HandleUserStatusUpdate(packet)));
                }
            }
            // Request updated online list
            Logger.Info("[Client] Sending RequestOnlineListPacket");
            SendPacket(new RequestOnlineListPacket());
        }

        // --- HÀM KẾT NỐI ĐƯỢC SỬA ĐỔI ---
        public async Task<bool> ConnectAsync(string ipAddress, int port)
        {
            // Ngắt kết nối cũ nếu có để tránh conflict
            DisconnectInternal(false);

            try
            {
                _client = new TcpClient();
                // === TỐI ƯU HÓA NETWORK ===
                // 1. Tăng buffer size
                _client.ReceiveBufferSize = 131072; // 128 KB
                _client.SendBufferSize = 131072;    // 128 KB

                // 2. Tối ưu hóa cho truyền tải gói tin nhỏ (chat/game)
                _client.NoDelay = true;
                _client.ReceiveTimeout = 60000;
                _client.SendTimeout = 60000;

                // 3. Cấu hình KeepAlive để phát hiện connection drop sớm
                _client.Client.SetSocketOption(System.Net.Sockets.SocketOptionLevel.Socket, System.Net.Sockets.SocketOptionName.KeepAlive, true);
                _client.Client.SetSocketOption(System.Net.Sockets.SocketOptionLevel.Tcp, System.Net.Sockets.SocketOptionName.TcpKeepAliveTime, 30000);
                _client.Client.SetSocketOption(System.Net.Sockets.SocketOptionLevel.Tcp, System.Net.Sockets.SocketOptionName.TcpKeepAliveInterval, 1000);

                Logger.Info($"Đang thử kết nối đến {ipAddress}:{port}...");

                // Sử dụng timeout 10s cho mạng Wifi (mạng LAN có thể cần thời gian tìm host)
                using var timeoutCts = new CancellationTokenSource(10000);
                try
                {
                    // Hỗ trợ cả .NET Framework và .NET Core bằng cách dùng ConnectAsync với Task.WhenAny
                    var connectTask = _client.ConnectAsync(ipAddress, port);
                    var completedTask = await Task.WhenAny(connectTask, Task.Delay(10000, timeoutCts.Token));

                    if (completedTask != connectTask)
                    {
                        Logger.Error($"Timeout: Không thể kết nối đến Server {ipAddress} sau 10 giây.");
                        DisconnectInternal(false);
                        return false;
                    }

                    // Nếu task hoàn thành, kiểm tra xem có exception không
                    await connectTask;
                }
                catch (Exception ex)
                {
                    // Lỗi xảy ra trong quá trình ConnectAsync
                    Logger.Error($"Lỗi trong quá trình kết nối: {ex.GetType().Name} - {ex.Message}");
                    DisconnectInternal(false);
                    throw;
                }

                // Kiểm tra _client không null và đã kết nối thành công
                if (_client != null && _client.Connected)
                {
                    try
                    {
                        _stream = _client.GetStream();
                        if (_stream == null)
                        {
                            Logger.Error("Không thể lấy NetworkStream từ TcpClient");
                            DisconnectInternal(false);
                            return false;
                        }

                        _listeningCts = new CancellationTokenSource();
                        // Bắt đầu lắng nghe gói tin từ Server
                        _ = StartListeningAsync(_listeningCts.Token);

                        CurrentServerIP = ipAddress;
                        CurrentServerPort = port;

                        Logger.Success($"Kết nối THÀNH CÔNG đến {ipAddress}:{port}!");
                        return true;
                    }
                    catch (Exception streamEx)
                    {
                        Logger.Error($"Lỗi khi khởi tạo stream: {streamEx.GetType().Name} - {streamEx.Message}");
                        DisconnectInternal(false);
                        return false;
                    }
                }
                else
                {
                    Logger.Error("Kết nối không thành công - Client không connected");
                    DisconnectInternal(false);
                    return false;
                }
            }
            catch (SocketException sockEx)
            {
                string msg = $"Lỗi Socket ({sockEx.SocketErrorCode}): Không thể kết nối đến {ipAddress}.";
                if (sockEx.SocketErrorCode == SocketError.ConnectionRefused)
                    msg += " (Server từ chối hoặc chưa mở Port 9000)";
                else if (sockEx.SocketErrorCode == SocketError.TimedOut)
                    msg += " (Sai IP hoặc Firewall chặn)";

                Logger.Error(msg);
            }
            catch (Exception ex)
            {
                Logger.Error($"Lỗi kết nối chung: {ex.GetType().Name} - {ex.Message}");
            }

            DisconnectInternal(false);
            return false;
        }

        private async Task StartListeningAsync(CancellationToken cancellationToken)
        {
            try
            {
                // Buffer tái sử dụng để giảm GC pressure
                byte[] lenBuf = new byte[4];
                
                while (_client != null && _client.Connected && _stream != null && !cancellationToken.IsCancellationRequested)
                {
                    object? receivedPacket = null;
                    try
                    {
                        // Kiểm tra stream trước khi deserialize
                        if (_stream == null || !_stream.CanRead)
                        {
                            Logger.Info("Stream không khả dụng, ngắt kết nối");
                            break;
                        }

                        // === CÁCH TỐI ƢU: Tái sử dụng lenBuf thay vì tạo mới mỗi lần ===
                        Array.Clear(lenBuf, 0, 4);
                        
                        // Đọc độ dài gói tin (4 bytes)
                        int read = 0;
                        while (read < 4)
                        {
                            int r = await _stream.ReadAsync(lenBuf, read, 4 - read, cancellationToken);
                            if (r == 0) throw new EndOfStreamException("Stream closed while reading length");
                            read += r;
                        }

                        int payloadLen = BitConverter.ToInt32(lenBuf, 0);
                        if (payloadLen <= 0) throw new InvalidDataException("Invalid payload length");

                        // Đọc nội dung gói tin theo độ dài đã đọc được
                        byte[] payload = new byte[payloadLen];
                        int offset = 0;
                        while (offset < payloadLen)
                        {
                            int r = await _stream.ReadAsync(payload, offset, payloadLen - offset, cancellationToken);
                            if (r == 0) throw new EndOfStreamException("Stream closed while reading payload");
                            offset += r;
                        }

                        using (var ms = new MemoryStream(payload, writable: false))
                        {
                            receivedPacket = _formatter.Deserialize(ms);
                        }
                    }
                    catch (System.Runtime.Serialization.SerializationException serEx)
                    {
                        // SerializationException xảy ra khi stream bị đóng hoặc dữ liệu không đúng format
                        // Đây là tình huống bình thường khi connection đóng hoặc dữ liệu corrupt
                        if (serEx.Message.Contains("End of Stream") || 
                            serEx.Message.Contains("parsing was completed") ||
                            serEx.Message.Contains("does not contain a valid BinaryHeader"))
                        {
                            Logger.Info($"Server đã đóng kết nối hoặc dữ liệu không hợp lệ: {serEx.Message}");
                        }
                        else
                        {
                            Logger.Warning($"Serialization error: {serEx.Message}");
                        }
                        break; // Break để đóng connection gracefully
                    }
                    catch (OperationCanceledException)
                    {
                        // Cancellation được yêu cầu, break normally
                        break;
                    }
                    catch (IOException ioEx)
                    {
                        // IOException xảy ra khi stream bị đóng
                        Logger.Info($"Stream đã bị đóng: {ioEx.Message}");
                        break;
                    }
                    catch (Exception ex)
                    {
                        Logger.Warning($"Lỗi khi deserialize: {ex.GetType().Name} - {ex.Message}");
                        break;
                    }

                    if (receivedPacket != null)
                    {
                        // Xử lý packet ngay tức thì (không có delay)
                        HandlePacket(receivedPacket);
                    }
                    else
                    {
                        // Nếu Deserialize trả về null -> Ngắt kết nối
                        Logger.Warning("Deserialize trả về null, ngắt kết nối");
                        break;
                    }
                }
            }
            catch (OperationCanceledException)
            {
                // Cancellation requested - normal exit
                Logger.Info("Listening cancelled");
            }
            catch (Exception ex)
            {
                if (!cancellationToken.IsCancellationRequested)
                    Logger.Warning($"Ngắt kết nối khi đang lắng nghe: {ex.GetType().Name} - {ex.Message}");
            }
            finally
            {
                // Thông báo rớt mạng nếu không phải do user chủ động ngắt
                if (!cancellationToken.IsCancellationRequested && _homeForm != null && !_homeForm.IsDisposed)
                {
                    _homeForm.BeginInvoke(new Action(() =>
                        MessageBox.Show("Mất kết nối đến máy chủ!", "Lỗi mạng", MessageBoxButtons.OK, MessageBoxIcon.Error)));
                    Disconnect();
                }
            }
        }

        private void HandlePacket(object packet)
        {
            try
            {
                if (packet is LoginResultPacket pLogin)
                {
                    TaskCompletionSource<LoginResultPacket>? completionSource;
                    lock (_loginLock) completionSource = _loginCompletionSource;

                    if (completionSource != null && !completionSource.Task.IsCompleted)
                        completionSource.TrySetResult(pLogin);
                    return;
                }
                if (packet is RegisterResultPacket pRegister)
                {
                    if (_registerCompletionSource != null && !_registerCompletionSource.Task.IsCompleted)
                        _registerCompletionSource.TrySetResult(pRegister);
                    return;
                }
                if (packet is ForgotPasswordResultPacket pForgot)
                {
                    OnForgotPasswordResult?.Invoke(pForgot);
                    return;
                }
                if (packet is ChatHistoryResponsePacket pChatHistory)
                {
                    if (_chatHistoryCompletionSource != null && !_chatHistoryCompletionSource.Task.IsCompleted)
                        _chatHistoryCompletionSource.TrySetResult(pChatHistory);
                    OnChatHistoryReceived?.Invoke(pChatHistory);
                    return;
                }

                // Queue UserStatusPacket if home form not ready
                if (packet is UserStatusPacket statusPacket && _homeForm == null)
                {
                    _pendingStatusPackets.Enqueue(statusPacket);
                    return;
                }

                if (string.IsNullOrEmpty(UserID) || _homeForm == null || _homeForm.IsDisposed) return;

                // Xử lý các gói tin UI
                Action? action = packet switch
                {
                    UserStatusPacket p => () => _homeForm.HandleUserStatusUpdate(p),
                    TextPacket p => () => _homeForm.HandleIncomingTextMessage(p),
                    FilePacket p => () => _homeForm.HandleIncomingFileMessage(p),
                    GameInvitePacket p => () => _homeForm.HandleIncomingGameInvite(p),
                    GameResponsePacket p => () => _homeForm.HandleGameResponse(p),
                    GameStartPacket p => () => _homeForm.HandleGameStart(p),
                    GameMovePacket p => () => _homeForm.HandleGameMove(p),
                    RematchRequestPacket p => () => _homeForm.HandleRematchRequest(p),
                    RematchResponsePacket p => () => _homeForm.HandleRematchResponse(p),
                    GameResetPacket p => () => _homeForm.HandleGameReset(p),
                    UpdateProfilePacket p => () => _homeForm.HandleUpdateProfile(p),
                    TankInvitePacket p => () => _homeForm.HandleTankInvite(p),
                    TankResponsePacket p => () => _homeForm.HandleTankResponse(p),
                    TankStartPacket p => () => _homeForm.HandleTankStart(p),
                    TankActionPacket p => () => _homeForm.HandleTankAction(p),
                    TankHitPacket p => () => _homeForm.HandleTankHit(p),
                    OnlineListPacket p => () => _homeForm.HandleOnlineListUpdate(p),
                    _ => null
                };

                if (action != null)
                {
                    try
                    {
                        if (_homeForm != null && !_homeForm.IsDisposed)
                        {
                            if (_homeForm.InvokeRequired)
                            {
                                _homeForm.BeginInvoke(action);
                            }
                            else
                            {
                                action();
                            }
                        }
                    }
                    catch (Exception ex)
                    {
                        Logger.Warning($"Lỗi khi invoke UI action: {ex.Message}");
                    }
                }
            }
            catch (Exception ex)
            {
                Logger.Error($"Lỗi xử lý packet {packet?.GetType().Name}: {ex.Message}");
            }
        }

        public async Task<LoginResultPacket> LoginAsync(LoginPacket packet)
        {
            if (_client == null || !_client.Connected) throw new InvalidOperationException("Chưa kết nối Server.");

            TaskCompletionSource<LoginResultPacket> completionSource;
            lock (_loginLock)
            {
                _loginCompletionSource = new TaskCompletionSource<LoginResultPacket>();
                completionSource = _loginCompletionSource;
            }

            if (!SendPacket(packet))
            {
                lock (_loginLock) _loginCompletionSource = null;
                throw new InvalidOperationException("Gửi gói tin đăng nhập thất bại.");
            }

            var timeoutTask = Task.Delay(15000); // 15s timeout
            var resultTask = completionSource.Task;

            if (await Task.WhenAny(resultTask, timeoutTask) == resultTask)
            {
                lock (_loginLock) _loginCompletionSource = null;
                return await resultTask;
            }

            lock (_loginLock) _loginCompletionSource = null;
            throw new TimeoutException("Server phản hồi quá lâu (Timeout).");
        }

        public async Task<RegisterResultPacket> RegisterAsync(RegisterPacket packet)
        {
            if (_client == null || !_client.Connected) throw new InvalidOperationException("Chưa kết nối.");
            _registerCompletionSource = new TaskCompletionSource<RegisterResultPacket>();
            SendPacket(packet);

            if (await Task.WhenAny(_registerCompletionSource.Task, Task.Delay(10000)) == _registerCompletionSource.Task)
                return await _registerCompletionSource.Task;
            else
                throw new TimeoutException("Đăng ký Timeout.");
        }

        public async Task<ChatHistoryResponsePacket> RequestChatHistoryAsync(string friendID, int limit = 100)
        {
            if (_client == null || !_client.Connected || string.IsNullOrEmpty(UserID))
                throw new InvalidOperationException("Chưa sẵn sàng.");

            _chatHistoryCompletionSource = new TaskCompletionSource<ChatHistoryResponsePacket>();

            var request = new ChatHistoryRequestPacket { UserID = UserID, FriendID = friendID, Limit = limit };
            if (!SendPacket(request)) return new ChatHistoryResponsePacket { Success = false };

            if (await Task.WhenAny(_chatHistoryCompletionSource.Task, Task.Delay(10000)) == _chatHistoryCompletionSource.Task)
                return await _chatHistoryCompletionSource.Task;

            return new ChatHistoryResponsePacket { Success = false, Message = "Timeout" };
        }

        public bool SendPacket(object packet)
        {
            NetworkStream? currentStream = _stream;
            if (_client == null || !_client.Connected || currentStream == null) return false;

            try
            {
                byte[] payload;
                using (var ms = new MemoryStream())
                {
                    _formatter.Serialize(ms, packet);
                    payload = ms.ToArray();
                }

                lock (currentStream)
                {
                    // Double-check after acquiring lock
                    if (_client == null || !_client.Connected || currentStream == null || !currentStream.CanWrite)
                    {
                        return false;
                    }

                    byte[] lenBuf = BitConverter.GetBytes(payload.Length);
                    currentStream.Write(lenBuf, 0, lenBuf.Length);
                    currentStream.Write(payload, 0, payload.Length);
                    currentStream.Flush();
                }
                return true;
            }
            catch (IOException ioEx)
            {
                Logger.Error($"Gửi packet thất bại (IOException): {ioEx.Message}");
                Disconnect();
                return false;
            }
            catch (ObjectDisposedException)
            {
                Logger.Warning("Stream đã bị đóng khi gửi packet");
                Disconnect();
                return false;
            }
            catch (Exception ex)
            {
                Logger.Error($"Gửi packet thất bại: {ex.GetType().Name} - {ex.Message}");
                return false;
            }
        }

        public void SetUserCredentials(string userId, string userName)
        {
            this.UserID = userId;
            this.UserName = userName;
        }

        public void Disconnect()
        {
            DisconnectInternal(true);
        }

        private void DisconnectInternal(bool showMessage)
        {
            try
            {
                _listeningCts?.Cancel();
                _stream?.Close();
                _client?.Close();
            }
            catch { }
            finally
            {
                _client = null;
                _stream = null;
                _listeningCts = null;
                // keep _homeForm for error display
                UserID = null;
                UserName = null;
                Logger.Info("Đã ngắt kết nối.");
            }
        }
    }
}
#pragma warning restore SYSLIB0011
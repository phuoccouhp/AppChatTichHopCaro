using ChatApp.Shared;
using System;
using System.Collections.Generic;

namespace ChatAppServer
{
    public class TankGameManager
    {
        // ✅ [FIX] Thêm lock object cho thread safety
        private readonly object _gamesLock = new object();
        private Dictionary<string, TankGameState> _games = new Dictionary<string, TankGameState>();

        public class TankGameState
        {
            public string? GameID { get; set; }
            public string? Player1ID { get; set; }
            public string? Player2ID { get; set; }
            public int Player1Health { get; set; } = 100;
            public int Player2Health { get; set; } = 100;
            public List<BulletInfo> Bullets { get; set; } = new List<BulletInfo>();
        }

        public class BulletInfo
        {
            public float X { get; set; }
            public float Y { get; set; }
            public float Angle { get; set; }
            public string? OwnerID { get; set; }
            public DateTime CreatedAt { get; set; }
        }

        public void StartGame(string gameID, string player1ID, string player2ID)
        {
            lock (_gamesLock)
            {
                _games[gameID] = new TankGameState
                {
                    GameID = gameID,
                    Player1ID = player1ID,
                    Player2ID = player2ID
                };
            }
        }

        public void AddBullet(string gameID, string ownerID, float x, float y, float angle)
        {
            lock (_gamesLock)
            {
                if (_games.TryGetValue(gameID, out var game))
                {
                    game.Bullets.Add(new BulletInfo
                    {
                        X = x,
                        Y = y,
                        Angle = angle,
                        OwnerID = ownerID,
                        CreatedAt = DateTime.Now
                    });
                }
            }
        }

        public void UpdateBullets(string gameID, Server server)
        {
            TankGameState? game = null;
            lock (_gamesLock)
            {
                _games.TryGetValue(gameID, out game);
            }
            
            if (game == null) return;

            const float BULLET_SPEED = 8f;
            const int BULLET_LIFETIME_MS = 5000;

            // ✅ [FIX] Copy list để tránh lock lâu
            List<BulletInfo> bulletsToProcess;
            lock (_gamesLock)
            {
                bulletsToProcess = new List<BulletInfo>(game.Bullets);
            }

            var bulletsToRemove = new List<BulletInfo>();

            foreach (var bullet in bulletsToProcess)
            {
                // Xóa đạn quá cũ
                if ((DateTime.Now - bullet.CreatedAt).TotalMilliseconds > BULLET_LIFETIME_MS)
                {
                    bulletsToRemove.Add(bullet);
                    continue;
                }

                // Cập nhật vị trí đạn
                float rad = bullet.Angle * (float)Math.PI / 180f;
                bullet.X += (float)Math.Cos(rad) * BULLET_SPEED;
                bullet.Y += (float)Math.Sin(rad) * BULLET_SPEED;
            }

            // Xóa đạn trong lock
            if (bulletsToRemove.Count > 0)
            {
                lock (_gamesLock)
                {
                    foreach (var bullet in bulletsToRemove)
                    {
                        game.Bullets.Remove(bullet);
                    }
                }
            }
        }

        public void ProcessHit(string gameID, string hitPlayerID, int damage, Server server)
        {
            TankGameState? game = null;
            bool isGameOver = false;
            string? winnerID = null;
            int remainingHealth = 0;
            bool isPlayer1 = false;

            lock (_gamesLock)
            {
                if (!_games.TryGetValue(gameID, out game)) return;

                isPlayer1 = (hitPlayerID == game.Player1ID);
                if (isPlayer1)
                {
                    game.Player1Health -= damage;
                    if (game.Player1Health < 0) game.Player1Health = 0;
                    remainingHealth = game.Player1Health;
                }
                else
                {
                    game.Player2Health -= damage;
                    if (game.Player2Health < 0) game.Player2Health = 0;
                    remainingHealth = game.Player2Health;
                }

                isGameOver = (game.Player1Health <= 0 || game.Player2Health <= 0);
                if (isGameOver)
                {
                    winnerID = game.Player1Health > 0 ? game.Player1ID : game.Player2ID;
                }
            }

            var hitPacket = new TankHitPacket
            {
                GameID = gameID,
                HitPlayerID = hitPlayerID,
                Damage = damage,
                RemainingHealth = remainingHealth,
                IsGameOver = isGameOver,
                WinnerID = winnerID
            };

            // Gửi packet ngoài lock để tránh deadlock
            server.RelayPrivatePacket(game.Player1ID, hitPacket);
            server.RelayPrivatePacket(game.Player2ID, hitPacket);

            if (isGameOver)
            {
                lock (_gamesLock)
                {
                    _games.Remove(gameID);
                }
            }
        }

        public void EndGame(string gameID)
        {
            lock (_gamesLock)
            {
                _games.Remove(gameID);
            }
        }
        
        public bool HasGame(string gameID)
        {
            lock (_gamesLock)
            {
                return _games.ContainsKey(gameID);
            }
        }
    }
}

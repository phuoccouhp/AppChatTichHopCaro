using ChatApp.Shared;
using System;
using System.Collections.Concurrent;
using System.Collections.Generic;
using System.Data.SqlClient;
using System.Threading;
using System.Threading.Tasks;

namespace ChatAppServer
{
    public class DatabaseManager
    {
        private readonly string _connectionString;
        private static DatabaseManager? _instance;
        public static DatabaseManager Instance => _instance ??= new DatabaseManager();

        // Cache user trong RAM
        private readonly ConcurrentDictionary<string, CachedUser> _userCache = new ConcurrentDictionary<string, CachedUser>(StringComparer.OrdinalIgnoreCase);
        private volatile bool _dbAvailable = false;

        private class CachedUser
        {
            public string Username { get; set; } = string.Empty;
            public string DisplayName { get; set; } = string.Empty;
            public string Password { get; set; } = string.Empty;
        }

        private DatabaseManager()
        {
            _connectionString = AppConfig.GetConnectionString("ChatAppDB");
            
            // Thêm timeout nếu chưa có
            var builder = new SqlConnectionStringBuilder(_connectionString);
            if (builder.ConnectTimeout < 30)
            {
                builder.ConnectTimeout = 30; // Tăng timeout lên 30s
            }
            _connectionString = builder.ConnectionString;
            
            CheckDatabaseConnection();
        }

        private void CheckDatabaseConnection()
        {
            try
            {
                Logger.Info("[Database] Đang kiểm tra kết nối SQL Server...");
                using (SqlConnection conn = new SqlConnection(_connectionString))
                {
                    conn.Open();
                    _dbAvailable = true;
                    Logger.Success("[Database] Kết nối SQL Server thành công!");
                }
            }
            catch (SqlException sqlEx)
            {
                _dbAvailable = false;
                
                // Diagnose specific SQL Server issues
                if (sqlEx.Message.Contains("timeout", StringComparison.OrdinalIgnoreCase))
                {
                    Logger.Error("[Database] Timeout kết nối SQL Server. Các nguyên nhân có thể:\n" +
                        "  1. SQL Server KHÔNG CHẠY hoặc không khả dụng\n" +
                        "  2. Firewall chặn port 1433 hoặc Named Pipes\n" +
                        "  3. SQL Server Express không được khởi động\n" +
                        "  4. Máy tính bị treo hoặc quá tải\n" +
                        "\n  CÁCH FIX:\n" +
                        "  - Kiểm tra SQL Server Management Studio có kết nối được không\n" +
                        "  - Chạy: services.msc -> Tìm 'SQL Server (SQLEXPRESS)' -> Start\n" +
                        "  - Hoặc: sqlplus.exe bằng SQL Server Configuration Manager", sqlEx);
                }
                else if (sqlEx.Message.Contains("login", StringComparison.OrdinalIgnoreCase))
                {
                    Logger.Error("[Database] Lỗi Authentication SQL Server. Kiểm tra:\n" +
                        "  1. User đang chạy app có quyền truy cập SQL Server không?\n" +
                        "  2. Database 'ChatAppDB' có tồn tại không?\n" +
                        "  3. SQL Server có bật Mixed Mode Authentication không?", sqlEx);
                }
                else if (sqlEx.Message.Contains("instance", StringComparison.OrdinalIgnoreCase))
                {
                    Logger.Error("[Database] Không tìm thấy SQL Server instance 'SQLEXPRESS':\n" +
                        "  1. Chạy 'sqlcmd -L' để liệt kê tất cả SQL Server instances\n" +
                        "  2. Cập nhật appsettings.json với instance name đúng\n" +
                        "  3. Hoặc dùng: Data Source=localhost (mặc định)", sqlEx);
                }
                else
                {
                    Logger.Error("[Database] Không thể kết nối SQL Server. Chi tiết lỗi:", sqlEx);
                }
            }
            catch (Exception ex)
            {
                Logger.Error("[Database] Lỗi khác khi kết nối SQL Server. Chế độ Offline.", ex);
                _dbAvailable = false;
            }
        }

        // --- HÀM QUAN TRỌNG: LẤY DANH SÁCH NGƯỜI ĐÃ TỪNG NHẮN TIN ---
        public List<UserStatus> GetContacts(string currentUsername)
        {
            var list = new List<UserStatus>();
            if (!_dbAvailable) return list;

            try
            {
                using (SqlConnection conn = new SqlConnection(_connectionString))
                {
                    conn.Open();

                    // Logic: Lấy tất cả SenderID và ReceiverID liên quan đến tôi
                    // Dùng DISTINCT để không trùng lặp
                    string query = @"
                        SELECT DISTINCT 
                            CASE 
                                WHEN SenderID = @me THEN ReceiverID 
                                ELSE SenderID 
                            END AS ContactID
                        FROM Messages
                        WHERE SenderID = @me OR ReceiverID = @me";

                    var contactIds = new List<string>();
                    using (SqlCommand cmd = new SqlCommand(query, conn))
                    {
                        cmd.Parameters.AddWithValue("@me", currentUsername);
                        using (var reader = cmd.ExecuteReader())
                        {
                            while (reader.Read())
                            {
                                if (!reader.IsDBNull(0))
                                    contactIds.Add(reader.GetString(0));
                            }
                        }
                    }

                    // Sau khi có list ID, lấy thông tin chi tiết (DisplayName) từ bảng Users
                    if (contactIds.Count > 0)
                    {
                        // Tạo chuỗi tham số cho câu lệnh IN (...)
                        // Lưu ý: Parameterize đúng cách để tránh SQL Injection
                        var parameters = new List<string>();
                        var cmdParams = new List<SqlParameter>();
                        for (int i = 0; i < contactIds.Count; i++)
                        {
                            string paramName = $"@p{i}";
                            parameters.Add(paramName);
                            cmdParams.Add(new SqlParameter(paramName, contactIds[i]));
                        }

                        string userQuery = $"SELECT Username, DisplayName, IsOnline FROM Users WHERE Username IN ({string.Join(",", parameters)})";

                        using (SqlCommand cmd = new SqlCommand(userQuery, conn))
                        {
                            cmd.Parameters.AddRange(cmdParams.ToArray());
                            using (var reader = cmd.ExecuteReader())
                            {
                                while (reader.Read())
                                {
                                    list.Add(new UserStatus
                                    {
                                        UserID = reader["Username"].ToString(),
                                        UserName = reader["DisplayName"] != DBNull.Value ? reader["DisplayName"].ToString() : reader["Username"].ToString(),
                                        IsOnline = false // Mặc định lấy từ DB cứ để false, Server sẽ check lại Socket để set true
                                    });
                                }
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Logger.Error($"[GetContacts] Lỗi lấy danh sách bạn bè: {ex.Message}");
            }
            return list;
        }

        // --- HÀM QUAN TRỌNG: LƯU TIN NHẮN VÀO DB ---
        public int SaveMessage(string sender, string receiver, string content, string type = "Text", string fileName = null)
        {
            if (!_dbAvailable) return 0;
            try
            {
                using (SqlConnection conn = new SqlConnection(_connectionString))
                {
                    conn.Open();
                    string query = @"
                        INSERT INTO Messages (SenderID, ReceiverID, MessageContent, MessageType, FileName, CreatedAt) 
                        OUTPUT INSERTED.MessageID 
                        VALUES (@s, @r, @c, @t, @f, GETDATE())";

                    using (SqlCommand cmd = new SqlCommand(query, conn))
                    {
                        cmd.Parameters.AddWithValue("@s", sender);
                        cmd.Parameters.AddWithValue("@r", receiver);
                        cmd.Parameters.AddWithValue("@c", content ?? "");
                        cmd.Parameters.AddWithValue("@t", type);
                        cmd.Parameters.AddWithValue("@f", (object)fileName ?? DBNull.Value);

                        int newId = (int)cmd.ExecuteScalar();
                        // Logger.Info($"[DB] Đã lưu tin nhắn ID: {newId}");
                        return newId;
                    }
                }
            }
            catch (Exception ex)
            {
                Logger.Error("[DB] Lỗi lưu tin nhắn", ex);
                return 0;
            }
        }

        // --- Các hàm hỗ trợ khác (Login, Register, UpdateStatus...) ---

        public UserData? Login(string usernameOrEmail, string password, bool useEmail = false)
        {
            if (!_dbAvailable) return null;
            try
            {
                using (SqlConnection conn = new SqlConnection(_connectionString))
                {
                    conn.Open();
                    string query = useEmail
                        ? "SELECT Username, DisplayName, Password FROM Users WHERE Email = @u"
                        : "SELECT Username, DisplayName, Password FROM Users WHERE Username = @u";

                    using (SqlCommand cmd = new SqlCommand(query, conn))
                    {
                        cmd.Parameters.AddWithValue("@u", usernameOrEmail);
                        using (SqlDataReader reader = cmd.ExecuteReader())
                        {
                            if (reader.Read())
                            {
                                string storedPass = reader["Password"].ToString();
                                string realUser = reader["Username"].ToString();
                                string display = reader["DisplayName"] != DBNull.Value ? reader["DisplayName"].ToString() : realUser;

                                // Nếu pass chưa hash (code cũ) thì so sánh thường, nếu hash rồi thì Verify
                                bool isValid = storedPass.Contains(":")
                                    ? PasswordHelper.VerifyPassword(password, storedPass)
                                    : storedPass == password;

                                if (isValid)
                                {
                                    // Nếu pass chưa hash -> tự động hash và update lại
                                    if (!storedPass.Contains(":"))
                                    {
                                        UpdatePasswordInDb(conn, realUser, password);
                                    }
                                    return new UserData { Username = realUser, DisplayName = display };
                                }
                            }
                        }
                    }
                }
            }
            catch (Exception ex) { Logger.Error("[Login] Lỗi DB", ex); }
            return null;
        }

        private void UpdatePasswordInDb(SqlConnection conn, string username, string plainPass)
        {
            try
            {
                string hash = PasswordHelper.HashPassword(plainPass);
                using (SqlCommand cmd = new SqlCommand("UPDATE Users SET Password = @p WHERE Username = @u", conn))
                {
                    cmd.Parameters.AddWithValue("@p", hash);
                    cmd.Parameters.AddWithValue("@u", username);
                    cmd.ExecuteNonQuery();
                }
            }
            catch { }
        }

        public bool RegisterUser(string username, string password, string email)
        {
            if (!_dbAvailable) return false;
            try
            {
                using (SqlConnection conn = new SqlConnection(_connectionString))
                {
                    conn.Open();
                    using (SqlCommand cmd = new SqlCommand("SELECT COUNT(*) FROM Users WHERE Username = @u", conn))
                    {
                        cmd.Parameters.AddWithValue("@u", username);
                        if ((int)cmd.ExecuteScalar() > 0) return false;
                    }

                    string hash = PasswordHelper.HashPassword(password);
                    using (SqlCommand cmd = new SqlCommand("INSERT INTO Users (Username, Password, DisplayName, Email) VALUES (@u, @p, @d, @e)", conn))
                    {
                        cmd.Parameters.AddWithValue("@u", username);
                        cmd.Parameters.AddWithValue("@p", hash);
                        cmd.Parameters.AddWithValue("@d", username);
                        cmd.Parameters.AddWithValue("@e", (object)email ?? DBNull.Value);
                        cmd.ExecuteNonQuery();
                    }
                    return true;
                }
            }
            catch (Exception ex)
            {
                Logger.Error("[Register] Lỗi DB", ex);
                return false;
            }
        }

        public void UpdateUserOnlineStatus(string username, bool isOnline)
        {
            if (!_dbAvailable) return;
            try
            {
                using (SqlConnection conn = new SqlConnection(_connectionString))
                {
                    conn.Open();
                    string query = isOnline
                        ? "UPDATE Users SET IsOnline = 1 WHERE Username = @u"
                        : "UPDATE Users SET IsOnline = 0, LastSeen = GETDATE() WHERE Username = @u";

                    using (SqlCommand cmd = new SqlCommand(query, conn))
                    {
                        cmd.Parameters.AddWithValue("@u", username);
                        cmd.ExecuteNonQuery();
                    }
                }
            }
            catch { }
        }

        public bool CheckEmailExists(string email)
        {
            if (!_dbAvailable) return false;
            try
            {
                using (SqlConnection conn = new SqlConnection(_connectionString))
                {
                    conn.Open();
                    using (SqlCommand cmd = new SqlCommand("SELECT COUNT(*) FROM Users WHERE Email = @e", conn))
                    {
                        cmd.Parameters.AddWithValue("@e", email);
                        return (int)cmd.ExecuteScalar() > 0;
                    }
                }
            }
            catch { return false; }
        }

        public void UpdatePassword(string email, string newPassword)
        {
            if (!_dbAvailable) return;
            try
            {
                using (SqlConnection conn = new SqlConnection(_connectionString))
                {
                    conn.Open();
                    string hash = PasswordHelper.HashPassword(newPassword);
                    using (SqlCommand cmd = new SqlCommand("UPDATE Users SET Password = @p WHERE Email = @e", conn))
                    {
                        cmd.Parameters.AddWithValue("@p", hash);
                        cmd.Parameters.AddWithValue("@e", email);
                        cmd.ExecuteNonQuery();
                    }
                }
            }
            catch (Exception ex) { Logger.Error("Lỗi UpdatePassword", ex); }
        }

        public void UpdateDisplayName(string username, string newName)
        {
            if (!_dbAvailable) return;
            try
            {
                using (SqlConnection conn = new SqlConnection(_connectionString))
                {
                    conn.Open();
                    using (SqlCommand cmd = new SqlCommand("UPDATE Users SET DisplayName = @n WHERE Username = @u", conn))
                    {
                        cmd.Parameters.AddWithValue("@n", newName);
                        cmd.Parameters.AddWithValue("@u", username);
                        cmd.ExecuteNonQuery();
                    }
                }
            }
            catch (Exception ex) { Logger.Error("Lỗi UpdateDisplayName", ex); }
        }

        public void UpdateMessage(int msgId, string newContent)
        {
            if (!_dbAvailable) return;
            try
            {
                using (SqlConnection conn = new SqlConnection(_connectionString))
                {
                    conn.Open();
                    using (SqlCommand cmd = new SqlCommand("UPDATE Messages SET MessageContent = @c WHERE MessageID = @id", conn))
                    {
                        cmd.Parameters.AddWithValue("@c", newContent);
                        cmd.Parameters.AddWithValue("@id", msgId);
                        cmd.ExecuteNonQuery();
                    }
                }
            }
            catch { }
        }

        public List<MessageData> GetChatHistory(string u1, string u2, int limit)
        {
            var list = new List<MessageData>();
            if (!_dbAvailable) return list;

            try
            {
                using (SqlConnection conn = new SqlConnection(_connectionString))
                {
                    conn.Open();
                    string query = @"SELECT TOP (@l) MessageID, SenderID, ReceiverID, MessageContent, MessageType, FileName, CreatedAt 
                                     FROM Messages 
                                     WHERE (SenderID=@u1 AND ReceiverID=@u2) OR (SenderID=@u2 AND ReceiverID=@u1) 
                                     ORDER BY CreatedAt DESC";

                    using (SqlCommand cmd = new SqlCommand(query, conn))
                    {
                        cmd.Parameters.AddWithValue("@u1", u1);
                        cmd.Parameters.AddWithValue("@u2", u2);
                        cmd.Parameters.AddWithValue("@l", limit);
                        using (var reader = cmd.ExecuteReader())
                        {
                            while (reader.Read())
                            {
                                list.Add(new MessageData
                                {
                                    MessageID = (int)reader["MessageID"],
                                    SenderID = reader["SenderID"].ToString(),
                                    ReceiverID = reader["ReceiverID"].ToString(),
                                    MessageContent = reader["MessageContent"]?.ToString(),
                                    MessageType = reader["MessageType"]?.ToString(),
                                    FileName = reader["FileName"] != DBNull.Value ? reader["FileName"].ToString() : null,
                                    CreatedAt = (DateTime)reader["CreatedAt"]
                                });
                            }
                        }
                    }
                }
                list.Reverse();
            }
            catch (Exception ex)
            {
                Logger.Error("Lỗi GetChatHistory", ex);
            }
            return list;
        }
    }

    // Helper classes
    public class UserData { public string Username { get; set; } public string DisplayName { get; set; } }
    public class MessageData
    {
        public int MessageID { get; set; }
        public string SenderID { get; set; }
        public string ReceiverID { get; set; }
        public string MessageContent { get; set; }
        public string MessageType { get; set; }
        public string? FileName { get; set; }
        public DateTime CreatedAt { get; set; }
    }
}
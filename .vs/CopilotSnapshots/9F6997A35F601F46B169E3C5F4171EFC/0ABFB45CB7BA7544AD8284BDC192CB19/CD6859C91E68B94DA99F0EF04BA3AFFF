#pragma warning disable SYSLIB0011
using ChatApp.Shared;
using System;
using System.IO;
using System.Linq;
using System.Net.Sockets;
using System.Text;
using System.Text.Json;
using System.Threading.Tasks;

namespace ChatAppServer
{
    public class ClientHandler
    {
        private TcpClient? _client;
        private Server _server;
        private NetworkStream? _stream;
        private JsonSerializerOptions _jsonOptions = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };

        public string? UserID { get; private set; }
        public string? UserName { get; private set; }
        public string ClientIP { get; private set; } = "Unknown";
        public DateTime LoginTime { get; private set; } = DateTime.Now;

        private string? _currentOtp = null;
        private string? _currentResetEmail = null;

        public ClientHandler(TcpClient client, Server server)
        {
            _client = client;
            _server = server;
            try
            {
                ClientIP = _client.Client.RemoteEndPoint?.ToString() ?? "Unknown";
                _stream = _client.GetStream();

                _client.ReceiveBufferSize = 131072;
                _client.SendBufferSize = 131072;
                _client.NoDelay = true;

                // Log new connection
                Logger.Info($"[CONNECT] New client connected: {ClientIP}");
            }
            catch (Exception ex)
            {
                Logger.Error("Error init handler", ex);
                Close();
            }
        }

        public async Task StartHandlingAsync()
        {
            if (_stream == null) return;
            byte[] lenBuf = new byte[4];

            while (_client != null && _client.Connected)
            {
                try
                {
                    int read = 0;
                    while (read < 4)
                    {
                        int r = await _stream.ReadAsync(lenBuf, read, 4 - read);
                        if (r == 0) return;
                        read += r;
                    }
                    int payloadLen = BitConverter.ToInt32(lenBuf, 0);

                    byte[] payload = new byte[payloadLen];
                    int offset = 0;
                    while (offset < payloadLen)
                    {
                        int r = await _stream.ReadAsync(payload, offset, payloadLen - offset);
                        if (r == 0) return;
                        offset += r;
                    }

                    string jsonString = Encoding.UTF8.GetString(payload);

                    // Log raw incoming payload (truncate long messages)
                    try
                    {
                        string snippet = jsonString.Length > 1000 ? jsonString.Substring(0, 1000) + "..." : jsonString;
                        Logger.Info($"[RECV RAW] {ClientIP}: {snippet}");
                    }
                    catch { }

                    PacketWrapper wrapper = null;
                    try
                    {
                        wrapper = JsonSerializer.Deserialize<PacketWrapper>(jsonString, _jsonOptions);
                    }
                    catch (Exception ex)
                    {
                        Logger.Error($"[DESERIALIZE ERROR] Failed to deserialize PacketWrapper from client {ClientIP}", ex);
                    }

                    if (wrapper == null)
                    {
                        Logger.Warning($"[WARNING] Received null or invalid PacketWrapper from {ClientIP}");
                        continue;
                    }

                    if (string.IsNullOrEmpty(wrapper.Type))
                    {
                        Logger.Warning($"[WARNING] PacketWrapper.Type empty from {ClientIP}");
                        continue;
                    }

                    Type type = PacketMapper.GetPacketType(wrapper.Type);

                    if (type == null)
                    {
                        Logger.Warning($"[UNKNOWN PACKET] From {ClientIP} Type='{wrapper.Type}' - payload size={wrapper.Payload?.Length}");
                        continue;
                    }

                    object packet = null;
                    try
                    {
                        packet = JsonSerializer.Deserialize(wrapper.Payload, type, _jsonOptions);
                    }
                    catch (Exception ex)
                    {
                        Logger.Error($"[DESERIALIZE ERROR] Failed to deserialize payload to {type.Name} from {ClientIP}", ex);
                        continue;
                    }

                    if (packet == null)
                    {
                        Logger.Warning($"[WARNING] Deserialized packet is null for type {type.Name} from {ClientIP}");
                        continue;
                    }

                    HandlePacket(packet);
                }
                catch (IOException) { break; }
                catch (Exception ex)
                {
                    Logger.Warning($"Lỗi xử lý gói tin: {ex.Message}");
                    break;
                }
            }
            Close();
        }

        public void SendPacket(object packet)
        {
            if (_stream == null || !_stream.CanWrite) return;
            try
            {
                string simpleTypeName = packet.GetType().Name;
                string payloadJson = JsonSerializer.Serialize(packet, packet.GetType(), _jsonOptions);

                var wrapper = new PacketWrapper { Type = simpleTypeName, Payload = payloadJson };
                string wrapperJson = JsonSerializer.Serialize(wrapper, _jsonOptions);

                byte[] data = Encoding.UTF8.GetBytes(wrapperJson);
                byte[] lenBuf = BitConverter.GetBytes(data.Length);

                lock (_stream)
                {
                    _stream.Write(lenBuf, 0, 4);
                    _stream.Write(data, 0, data.Length);
                    _stream.Flush();
                }
            }
            catch { Close(); }
        }

        private void HandlePacket(object packet)
        {
            switch (packet)
            {
                case LoginPacket p: HandleLogin(p); break;
                case RegisterPacket p: HandleRegister(p); break;
                case ForgotPasswordPacket p: HandleForgotPasswordRequest(p); break;
                case ResetPasswordPacket p: HandleResetPassword(p); break;
                case UpdateProfilePacket p: HandleUpdateProfile(p); break;
                case ChatHistoryRequestPacket p: HandleChatHistoryRequest(p); break;
                case RequestOnlineListPacket p: HandleRequestOnlineList(p); break;

                case TextPacket p:
                    Logger.Info($"[Chat] {p.SenderID} -> {p.ReceiverID}: {p.MessageContent}");
                    _server.RelayPrivatePacket(p.ReceiverID, p);
                    _ = Task.Run(() => DatabaseManager.Instance.SaveMessage(p.SenderID, p.ReceiverID, p.MessageContent));
                    break;

                case FilePacket p:
                    Logger.Info($"[File] {p.SenderID} -> {p.ReceiverID}: {p.FileName}");
                    _server.RelayPrivatePacket(p.ReceiverID, p);
                    _ = Task.Run(() => DatabaseManager.Instance.SaveMessage(p.SenderID, p.ReceiverID, $"Sent file: {p.FileName}", p.IsImage ? "Image" : "File", p.FileName));
                    break;

                case GameInvitePacket p:
                    Logger.Info($"[GameInvite] {p.SenderID} -> {p.ReceiverID}");
                    _server.RelayPrivatePacket(p.ReceiverID, p);
                    _ = Task.Run(() =>
                    {
                        int id = DatabaseManager.Instance.SaveMessage(p.SenderID, p.ReceiverID, "Invited to play Caro", "GameInvite", "Caro");
                        _server.StoreGameInviteMessageId(p.SenderID, p.ReceiverID, id);
                    });
                    break;

                case TankInvitePacket p:
                    Logger.Info($"[TankInvite] {p.SenderID} -> {p.ReceiverID}");
                    _server.RelayPrivatePacket(p.ReceiverID, p);
                    _ = Task.Run(() =>
                    {
                        int id = DatabaseManager.Instance.SaveMessage(p.SenderID, p.ReceiverID, "Invited to play Tank", "GameInvite", "Tank");
                        _server.StoreGameInviteMessageId(p.SenderID, p.ReceiverID, id);
                    });
                    break;

                case GameResponsePacket p: _server.ProcessGameResponse(p); break;
                case GameMovePacket p: _server.ProcessGameMove(p); break;
                case RematchRequestPacket p: _server.ProcessRematchRequest(p); break;
                case RematchResponsePacket p: _server.ProcessRematchResponse(p); break;
                case TankResponsePacket p: _server.ProcessTankResponse(p); break;
                case TankActionPacket p: _server.ProcessTankAction(p); break;
                case TankHitPacket p: _server.TankGameManager.ProcessHit(p.GameID, p.HitPlayerID, p.Damage, _server); break;
            }
        }

        private void HandleLogin(LoginPacket p)
        {
            var user = DatabaseManager.Instance.Login(p.Username ?? p.Email, p.Password, p.UseEmailLogin);
            if (user != null)
            {
                UserID = user.Username;
                UserName = user.DisplayName;

                // === THÊM LOG ĐĂNG NHẬP Ở ĐÂY ===
                Logger.Success($"[LOGIN] User '{UserName}' ({UserID}) đã đăng nhập từ IP: {ClientIP}");

                _server.RegisterClient(UserID, this);
                SendPacket(new LoginResultPacket { Success = true, UserID = UserID, UserName = UserName, OnlineUsers = _server.GetOnlineUsers(UserID) });
            }
            else
            {
                Logger.Warning($"[LOGIN FAIL] Đăng nhập thất bại từ IP {ClientIP} với user: {p.Username ?? p.Email}");
                SendPacket(new LoginResultPacket { Success = false, Message = "Sai tài khoản hoặc mật khẩu" });
                Close();
            }
        }

        private void HandleRegister(RegisterPacket p)
        {
            bool ok = DatabaseManager.Instance.RegisterUser(p.Username, p.Password, p.Email);
            if (ok) Logger.Success($"[REGISTER] Đăng ký thành công user mới: {p.Username}");
            else Logger.Warning($"[REGISTER FAIL] Đăng ký thất bại user: {p.Username}");

            SendPacket(new RegisterResultPacket { Success = ok, Message = ok ? "Success" : "User exists" });
        }

        private void HandleForgotPasswordRequest(ForgotPasswordPacket p)
        {
            if (DatabaseManager.Instance.CheckEmailExists(p.Email))
            {
                _currentOtp = new Random().Next(100000, 999999).ToString();
                _currentResetEmail = p.Email;
                EmailHelper.SendOTP(p.Email, _currentOtp);
                Logger.Info($"[ForgotPass] Đã gửi OTP cho email: {p.Email}");
                SendPacket(new ForgotPasswordResultPacket { Success = true, IsStep1Success = true, Message = "OTP Sent" });
            }
            else
            {
                SendPacket(new ForgotPasswordResultPacket { Success = false, Message = "Email not found" });
            }
        }

        private void HandleResetPassword(ResetPasswordPacket p)
        {
            if (_currentOtp == p.OtpCode && _currentResetEmail == p.Email)
            {
                DatabaseManager.Instance.UpdatePassword(p.Email, p.NewPassword);
                Logger.Success($"[ResetPass] Đổi mật khẩu thành công cho email: {p.Email}");
                SendPacket(new ForgotPasswordResultPacket { Success = true, IsStep1Success = false, Message = "Password Changed" });
            }
            else
            {
                SendPacket(new ForgotPasswordResultPacket { Success = false, Message = "Invalid OTP" });
            }
        }

        private void HandleUpdateProfile(UpdateProfilePacket p)
        {
            DatabaseManager.Instance.UpdateDisplayName(p.UserID, p.NewDisplayName);
            this.UserName = p.NewDisplayName;
            Logger.Info($"[Profile] User {UserID} đổi tên thành: {p.NewDisplayName}");
            _server.BroadcastPacket(p, null);
        }

        private void HandleChatHistoryRequest(ChatHistoryRequestPacket p)
        {
            var dbMessages = DatabaseManager.Instance.GetChatHistory(p.UserID, p.FriendID, p.Limit);
            var sharedMessages = dbMessages.Select(m => new ChatHistoryMessage
            {
                MessageID = m.MessageID,
                SenderID = m.SenderID ?? "",
                ReceiverID = m.ReceiverID ?? "",
                MessageContent = m.MessageContent ?? "",
                MessageType = m.MessageType,
                FileName = m.FileName,
                CreatedAt = m.CreatedAt
            }).ToList();

            var response = new ChatHistoryResponsePacket { Success = true, Message = "OK", Messages = sharedMessages };
            SendPacket(response);
        }

        private void HandleRequestOnlineList(RequestOnlineListPacket p)
        {
            SendPacket(new OnlineListPacket { OnlineUsers = _server.GetOnlineUsers(UserID) });
        }

        public void Close()
        {
            if (UserID != null)
            {
                Logger.Warning($"[LOGOUT] User '{UserName}' ({UserID}) đã ngắt kết nối.");
                _server.RemoveClient(UserID);
            }
            _client?.Close();
        }
    }
}
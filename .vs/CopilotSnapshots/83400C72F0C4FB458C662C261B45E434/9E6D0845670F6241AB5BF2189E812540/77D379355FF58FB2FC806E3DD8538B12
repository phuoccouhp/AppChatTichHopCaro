using System;
using ChatApp.Shared;
using System.Collections.Generic;
using System.Data.SqlClient;
using System.Threading;
using System.Threading.Tasks;
using System.Collections.Concurrent;

namespace ChatAppServer
{
    public class DatabaseManager
    {
        private readonly string _originalConnectionString;
        private string _connectionString;
        private static DatabaseManager? _instance;
        public static DatabaseManager Instance => _instance ??= new DatabaseManager();

        private bool _messagesTableExists = true; // assume true until checked

        // lightweight in-memory user cache to allow login when DB is temporarily unavailable
        private readonly ConcurrentDictionary<string, CachedUser> _userCache = new ConcurrentDictionary<string, CachedUser>(StringComparer.OrdinalIgnoreCase);
        private volatile bool _dbAvailable = false;
        private readonly CancellationTokenSource _cts = new CancellationTokenSource();

        // Queue for pending online status updates to avoid blocking during login when DB is slow
        private readonly ConcurrentQueue<(string Username, bool IsOnline)> _pendingStatusUpdates = new ConcurrentQueue<(string, bool)>();
        private readonly SemaphoreSlim _pendingStatusSignal = new SemaphoreSlim(0);

        private class CachedUser
        {
            public string Username { get; set; } = string.Empty;
            public string DisplayName { get; set; } = string.Empty;
            public string Password { get; set; } = string.Empty; // hashed or plain as stored
        }

        private DatabaseManager()
        {
            _originalConnectionString = AppConfig.GetConnectionString("ChatAppDB");
            _connectionString = _originalConnectionString;

            // Configure connection string for fast failure initially and enable MARS/pool
            try
            {
                var builder = new SqlConnectionStringBuilder(_connectionString);
                // fail fast on connect so server doesn't block long on startup/login
                if (builder.ConnectTimeout > 5) builder.ConnectTimeout = 5;
                builder.MultipleActiveResultSets = true;
                builder.MaxPoolSize = Math.Max(builder.MaxPoolSize, 200);
                _connectionString = builder.ConnectionString;
                Logger.Info($"[DatabaseManager] Initialized with fast ConnectTimeout={builder.ConnectTimeout}s, MARS={builder.MultipleActiveResultSets}, MaxPoolSize={builder.MaxPoolSize}");
            }
            catch (Exception ex)
            {
                Logger.Warning($"[DatabaseManager] Could not adjust connection string: {ex.Message}");
            }

            // Start background loader to populate user cache and monitor DB availability
            Task.Run(() => UserCacheLoop(_cts.Token));

            // Start background worker to flush pending status updates
            Task.Run(() => ProcessPendingStatusUpdates(_cts.Token));

            // Seed fallback test accounts so app can be used while DB is unreachable
            SeedFallbackTestAccounts();
        }

        // Seed a small set of test users consistent with provided DB setup
        private void SeedFallbackTestAccounts()
        {
            // Only seed if cache is empty
            if (_userCache.Count > 0) return;

            var testAccounts = new List<CachedUser>
            {
                new CachedUser { Username = "user1", DisplayName = "Bạn Bè A", Password = "123" },
                new CachedUser { Username = "user2", DisplayName = "Bạn Bè B", Password = "123" },
                new CachedUser { Username = "user3", DisplayName = "Bạn Bè C", Password = "123" },
                new CachedUser { Username = "user5", DisplayName = "Bạn Bè D", Password = "123" },
                new CachedUser { Username = "admin", DisplayName = "Quản Trị Viên", Password = "admin" },
                new CachedUser { Username = "test1", DisplayName = "Người Dùng Test 1", Password = "test123" },
                new CachedUser { Username = "test2", DisplayName = "Người Dùng Test 2", Password = "test123" },
                new CachedUser { Username = "huyphuoc", DisplayName = "Huy Phước", Password = "123" },
                new CachedUser { Username = "huyphuoc1", DisplayName = "Huy Phước 1", Password = "123123" }
            };

            foreach (var acc in testAccounts)
            {
                _userCache[acc.Username] = acc;
            }

            Logger.Info($"[DatabaseManager] Seeded {_userCache.Count} fallback test accounts into cache.");
        }

        private async Task UserCacheLoop(CancellationToken ct)
        {
            while (!ct.IsCancellationRequested)
            {
                try
                {
                    bool loaded = await TryLoadUsersToCacheAsync();
                    _dbAvailable = loaded;

                    // if DB available, increase connect timeout for normal ops
                    if (loaded)
                    {
                        try
                        {
                            var builder = new SqlConnectionStringBuilder(_originalConnectionString);
                            if (builder.ConnectTimeout < 30) builder.ConnectTimeout = 30;
                            builder.MultipleActiveResultSets = true;
                            builder.MaxPoolSize = Math.Max(builder.MaxPoolSize, 200);
                            _connectionString = builder.ConnectionString;
                        }
                        catch { /* ignore */ }

                        // Wait longer when DB is healthy
                        await Task.Delay(TimeSpan.FromSeconds(15), ct);
                    }
                    else
                    {
                        // Retry sooner when DB is down
                        await Task.Delay(TimeSpan.FromSeconds(5), ct);
                    }
                }
                catch (TaskCanceledException) { break; }
                catch (Exception ex)
                {
                    Logger.Warning($"[DatabaseManager] UserCacheLoop error: {ex.Message}");
                    await Task.Delay(5000, ct);
                }
            }
        }

        private async Task<bool> TryLoadUsersToCacheAsync()
        {
            try
            {
                var users = new List<CachedUser>();
                using (SqlConnection conn = new SqlConnection(_connectionString))
                {
                    // short open timeout already set on connection string
                    await conn.OpenAsync();
                    using (SqlCommand cmd = new SqlCommand("SELECT Username, DisplayName, Password FROM Users", conn))
                    {
                        cmd.CommandTimeout = 10;
                        using (var reader = await cmd.ExecuteReaderAsync())
                        {
                            while (await reader.ReadAsync())
                            {
                                users.Add(new CachedUser
                                {
                                    Username = reader["Username"]?.ToString() ?? string.Empty,
                                    DisplayName = reader["DisplayName"]?.ToString() ?? string.Empty,
                                    Password = reader["Password"]?.ToString() ?? string.Empty
                                });
                            }
                        }
                    }
                }

                // update cache atomically
                var newCache = new ConcurrentDictionary<string, CachedUser>(StringComparer.OrdinalIgnoreCase);
                foreach (var u in users)
                {
                    if (!string.IsNullOrEmpty(u.Username)) newCache[u.Username] = u;
                }

                _userCache.Clear();
                foreach (var kv in newCache) _userCache[kv.Key] = kv.Value;

                Logger.Info($"[DatabaseManager] Loaded {_userCache.Count} users into cache.");
                return true;
            }
            catch (Exception ex)
            {
                Logger.Warning($"[DatabaseManager] Unable to load users for cache: {ex.Message}");
                return false;
            }
        }

        // Return true if Messages table exists (do not create tables at runtime for production DB)
        private bool EnsureMessagesTableExists()
        {
            try
            {
                using (SqlConnection conn = new SqlConnection(_connectionString))
                {
                    conn.Open();
                    string checkSql = "SELECT OBJECT_ID('dbo.Messages','U')";
                    using (SqlCommand cmd = new SqlCommand(checkSql, conn))
                    {
                        object obj = cmd.ExecuteScalar();
                        return (obj != null && obj != DBNull.Value);
                    }
                }
            }
            catch (Exception ex)
            {
                Logger.Warning($"[EnsureMessagesTableExists] Error checking Messages table existence: {ex.Message}");
                return false;
            }
        }

        // New: update user's online flag and LastSeen
        public void UpdateUserOnlineStatus(string username, bool isOnline)
        {
            try
            {
                // Enqueue request and return immediately so login/register flows are not blocked by slow DB
                _pendingStatusUpdates.Enqueue((username, isOnline));
                _pendingStatusSignal.Release();
            }
            catch (Exception ex)
            {
                Logger.Warning($"[UpdateUserOnlineStatus] Failed to enqueue status for {username}: {ex.Message}");
            }

            // update cache if present
            if (_userCache.TryGetValue(username, out var cached))
            {
                // nothing to change except maybe last seen not stored in cache
                _userCache[username] = cached;
            }
        }

        // Background worker to process pending status updates with short connect timeout and retries
        private async Task ProcessPendingStatusUpdates(CancellationToken ct)
        {
            while (!ct.IsCancellationRequested)
            {
                try
                {
                    await _pendingStatusSignal.WaitAsync(ct);
                }
                catch (OperationCanceledException) { break; }

                // Dequeue and process all available items
                while (_pendingStatusUpdates.TryDequeue(out var item))
                {
                    string username = item.Username;
                    bool isOnline = item.IsOnline;

                    bool success = false;
                    int attempts = 0;

                    while (!success && attempts < 3 && !ct.IsCancellationRequested)
                    {
                        attempts++;
                        try
                        {
                            // Use a very short connect timeout for these opportunistic updates
                            var builder = new SqlConnectionStringBuilder(_originalConnectionString)
                            {
                                ConnectTimeout = 3,
                                MultipleActiveResultSets = true
                            };
                            builder.MaxPoolSize = Math.Max(builder.MaxPoolSize, 200);
                            string fastConn = builder.ConnectionString;

                            using (SqlConnection conn = new SqlConnection(fastConn))
                            {
                                // prefer async open when possible
                                await conn.OpenAsync(ct).ConfigureAwait(false);
                                string query = isOnline
                                    ? "UPDATE Users SET IsOnline = 1 WHERE Username = @u"
                                    : "UPDATE Users SET IsOnline = 0, LastSeen = GETDATE() WHERE Username = @u";
                                using (SqlCommand cmd = new SqlCommand(query, conn))
                                {
                                    cmd.Parameters.AddWithValue("@u", username);
                                    await cmd.ExecuteNonQueryAsync(ct).ConfigureAwait(false);
                                }
                            }

                            success = true;
                        }
                        catch (OperationCanceledException) { break; }
                        catch (Exception ex)
                        {
                            // If it fails, wait a bit and retry; also log once per attempt
                            Logger.Warning($"[ProcessPendingStatusUpdates] Attempt {attempts} failed for {username}: {ex.Message}");

                            // small backoff
                            try { await Task.Delay(1000 * attempts, ct).ConfigureAwait(false); } catch { }
                        }
                    }

                    if (!success)
                    {
                        // If still failed after retries, re-enqueue for later processing to avoid dropping status permanently
                        _pendingStatusUpdates.Enqueue((username, isOnline));
                        // avoid tight loop: delay before next background attempt
                        try { await Task.Delay(5000, ct).ConfigureAwait(false); } catch { }
                        // Signal to process again later
                        _pendingStatusSignal.Release();
                        // break to allow other work or cancellation to be observed
                        break;
                    }
                }
            }
        }

        // Hàm kiểm tra đăng nhập (hỗ trợ cả username và email) - với password hashing
        public UserData? Login(string usernameOrEmail, string password, bool useEmail = false)
        {
            // Try DB login if DB available; otherwise fallback to cache
            if (_dbAvailable)
            {
                try
                {
                    using (SqlConnection conn = new SqlConnection(_connectionString))
                    {
                        conn.Open();
                        string query = useEmail ? "SELECT Username, DisplayName, Password FROM Users WHERE Email = @u" : "SELECT Username, DisplayName, Password FROM Users WHERE Username = @u";

                        string? storedPassword = null;
                        string username = "";
                        string displayName = "";
                        bool needToHashPassword = false;
                        bool passwordValid = false;

                        using (SqlCommand cmd = new SqlCommand(query, conn))
                        {
                            cmd.CommandTimeout = 30;
                            cmd.Parameters.AddWithValue("@u", usernameOrEmail);

                            using (SqlDataReader reader = cmd.ExecuteReader())
                            {
                                if (reader.Read())
                                {
                                    storedPassword = reader["Password"]?.ToString();
                                    username = reader["Username"]?.ToString() ?? "";
                                    displayName = reader["DisplayName"]?.ToString() ?? "";

                                    if (string.IsNullOrEmpty(storedPassword))
                                    {
                                        Logger.Warning($"[Login] Password trong database rỗng cho user: {username}");
                                        return null;
                                    }
                                }
                                else
                                {
                                    Logger.Warning($"[Login] Không tìm thấy user: {usernameOrEmail}");
                                    return null;
                                }
                            }
                        }

                        storedPassword = storedPassword?.Trim();
                        password = password.Trim();

                        if (storedPassword == null) return null;

                        if (storedPassword.Contains(":"))
                        {
                            passwordValid = PasswordHelper.VerifyPassword(password, storedPassword);
                        }
                        else
                        {
                            passwordValid = storedPassword.Equals(password, StringComparison.Ordinal);
                            if (passwordValid) needToHashPassword = true;
                        }

                        if (needToHashPassword && passwordValid)
                        {
                            try
                            {
                                string hashedPassword = PasswordHelper.HashPassword(password);
                                UpdatePasswordForUserSeparateConnection(username, hashedPassword);
                                Logger.Info($"[Migration] Đã tự động hash password cho user: {username}");
                            }
                            catch (Exception ex)
                            {
                                Logger.Warning($"[Migration] Lỗi khi hash password cho user: {username} - {ex.Message}");
                            }
                        }

                        if (passwordValid)
                        {
                            // update cache with latest info
                            _userCache[username] = new CachedUser { Username = username, DisplayName = displayName, Password = storedPassword };
                            return new UserData { Username = username, DisplayName = displayName };
                        }
                    }
                }
                catch (Exception ex)
                {
                    Logger.Warning($"[Login] DB login failed, falling back to cache: {ex.Message}");
                    _dbAvailable = false;
                }
            }

            // Fallback: try cache
            try
            {
                if (string.IsNullOrEmpty(usernameOrEmail)) return null;

                // If usernameOrEmail looks like email, try to find by email in DB is required; but cache stores only username keys.
                // We'll try direct username lookup first.
                if (_userCache.TryGetValue(usernameOrEmail, out var cached))
                {
                    string storedPassword = cached.Password ?? string.Empty;
                    if (string.IsNullOrEmpty(storedPassword)) return null;

                    if (storedPassword.Contains(":"))
                    {
                        if (PasswordHelper.VerifyPassword(password.Trim(), storedPassword.Trim()))
                            return new UserData { Username = cached.Username, DisplayName = cached.DisplayName };
                    }
                    else
                    {
                        if (storedPassword.Equals(password.Trim(), StringComparison.Ordinal))
                            return new UserData { Username = cached.Username, DisplayName = cached.DisplayName };
                    }
                }

                // try find by display name or email not supported in cache; return null
            }
            catch (Exception ex)
            {
                Logger.Warning($"[Login] Cache fallback error: {ex.Message}");
            }

            return null;
        }

        // (Trong class DatabaseManager)
        public void UpdateDisplayName(string username, string newDisplayName)
        {
            try
            {
                using (SqlConnection conn = new SqlConnection(_connectionString))
                {
                    conn.Open();
                    string query = "UPDATE Users SET DisplayName = @name WHERE Username = @u";
                    using (SqlCommand cmd = new SqlCommand(query, conn))
                    {
                        cmd.Parameters.AddWithValue("@name", newDisplayName);
                        cmd.Parameters.AddWithValue("@u", username);
                        cmd.ExecuteNonQuery();
                    }
                }

                // update cache
                if (_userCache.TryGetValue(username, out var cached))
                {
                    cached.DisplayName = newDisplayName;
                    _userCache[username] = cached;
                }
            }
            catch (Exception ex)
            {
                Logger.Error("Lỗi cập nhật tên User", ex);
            }
        }

        // (Trong DatabaseManager.cs)

        public bool RegisterUser(string username, string password, string email)
        {
            try
            {
                using (SqlConnection conn = new SqlConnection(_connectionString))
                {
                    conn.Open();
                    // Kiểm tra xem user đã tồn tại chưa
                    string checkQuery = "SELECT COUNT(*) FROM Users WHERE Username = @u";
                    using (SqlCommand checkCmd = new SqlCommand(checkQuery, conn))
                    {
                        checkCmd.Parameters.AddWithValue("@u", username);
                        int count = (int)checkCmd.ExecuteScalar();
                        if (count > 0) return false; // Username đã tồn tại
                    }

                    // Nếu chưa, thêm mới
                    // Hash password trước khi lưu
                    string hashedPassword = PasswordHelper.HashPassword(password);

                    // Mặc định Tên hiển thị (DisplayName) sẽ giống Username
                    string insertQuery = "INSERT INTO Users (Username, Password, DisplayName, Email) VALUES (@u, @p, @d, @e)";
                    using (SqlCommand cmd = new SqlCommand(insertQuery, conn))
                    {
                        cmd.Parameters.AddWithValue("@u", username);
                        cmd.Parameters.AddWithValue("@p", hashedPassword); // Lưu password đã hash
                        cmd.Parameters.AddWithValue("@d", username); // DisplayName mặc định
                        cmd.Parameters.AddWithValue("@e", email);
                        cmd.ExecuteNonQuery();
                    }
                }

                // update cache
                _userCache[username] = new CachedUser { Username = username, DisplayName = username, Password = PasswordHelper.HashPassword(password) };
                return true;
            }
            catch (Exception ex)
            {
                Logger.Error("Lỗi Đăng ký User", ex);
                return false;
            }
        }
        // (Trong DatabaseManager.cs)

        // Kiểm tra email có tồn tại không
        public bool CheckEmailExists(string email)
        {
            try
            {
                using (SqlConnection conn = new SqlConnection(_connectionString))
                {
                    conn.Open();
                    string query = "SELECT COUNT(*) FROM Users WHERE Email = @e";
                    using (SqlCommand cmd = new SqlCommand(query, conn))
                    {
                        cmd.Parameters.AddWithValue("@e", email);
                        return (int)cmd.ExecuteScalar() > 0;
                    }
                }
            }
            catch (Exception ex)
            {
                Logger.Warning($"[CheckEmailExists] DB error: {ex.Message}. Falling back to cache.");
                // fallback: scan cache
                foreach (var kv in _userCache.Values)
                {
                    // cache does not store email in current implementation
                }
                return false;
            }
        }

        // Helper method để update password theo username (dùng trong migration)
        // Sử dụng connection riêng để tránh conflict với reader đang mở
        private void UpdatePasswordForUserSeparateConnection(string username, string hashedPassword)
        {
            using (SqlConnection conn = new SqlConnection(_connectionString))
            {
                conn.Open();
                string query = "UPDATE Users SET Password = @p WHERE Username = @u";
                using (SqlCommand cmd = new SqlCommand(query, conn))
                {
                    cmd.Parameters.AddWithValue("@p", hashedPassword);
                    cmd.Parameters.AddWithValue("@u", username);
                    cmd.ExecuteNonQuery();
                }
            }

            if (_userCache.TryGetValue(username, out var cached))
            {
                cached.Password = hashedPassword;
                _userCache[username] = cached;
            }
        }

        // Cập nhật mật khẩu mới - với password hashing
        public void UpdatePassword(string email, string newPassword)
        {
            try
            {
                using (SqlConnection conn = new SqlConnection(_connectionString))
                {
                    conn.Open();
                    // Hash password trước khi lưu
                    string hashedPassword = PasswordHelper.HashPassword(newPassword);

                    string query = "UPDATE Users SET Password = @p WHERE Email = @e";
                    using (SqlCommand cmd = new SqlCommand(query, conn))
                    {
                        cmd.Parameters.AddWithValue("@p", hashedPassword);
                        cmd.Parameters.AddWithValue("@e", email);
                        cmd.ExecuteNonQuery();
                    }
                }
            }
            catch (Exception ex)
            {
                Logger.Error("Lỗi cập nhật mật khẩu", ex);
            }
        }

        // Lưu tin nhắn vào database và trả về MessageID
        public int SaveMessage(string senderID, string receiverID, string messageContent, string messageType = "Text", string? fileName = null)
        {
            // Ensure MessageContent is NOT NULL to match DB schema
            if (messageContent == null) messageContent = string.Empty;

            if (!_dbAvailable)
            {
                Logger.Warning("[SaveMessage] DB unavailable, skipping persistent save.");
                return 0;
            }

            using (SqlConnection conn = new SqlConnection(_connectionString))
            {
                try
                {
                    conn.Open();
                    string query = @"INSERT INTO Messages (SenderID, ReceiverID, MessageContent, MessageType, FileName, CreatedAt) 
                                     OUTPUT INSERTED.MessageID
                                     VALUES (@sender, @receiver, @content, @type, @fileName, GETDATE())";

                    using (SqlCommand cmd = new SqlCommand(query, conn))
                    {
                        cmd.Parameters.AddWithValue("@sender", senderID);
                        cmd.Parameters.AddWithValue("@receiver", receiverID);
                        cmd.Parameters.AddWithValue("@content", messageContent);
                        cmd.Parameters.AddWithValue("@type", messageType);
                        cmd.Parameters.AddWithValue("@fileName", fileName ?? (object)DBNull.Value);
                        object result = cmd.ExecuteScalar();
                        return result != null ? Convert.ToInt32(result) : 0;
                    }
                }
                catch (SqlException sqlEx)
                {
                    Logger.Error("Lỗi lưu tin nhắn vào database", sqlEx);
                    return 0;
                }
                catch (Exception ex)
                {
                    Logger.Error("Lỗi lưu tin nhắn vào database", ex);
                    return 0;
                }
            }
        }

        // Cập nhật nội dung tin nhắn
        public void UpdateMessage(int messageID, string newContent)
        {
            if (!_messagesTableExists)
            {
                try { _messagesTableExists = EnsureMessagesTableExists(); }
                catch { return; }
            }

            try
            {
                using (SqlConnection conn = new SqlConnection(_connectionString))
                {
                    conn.Open();
                    string query = @"UPDATE Messages SET MessageContent = @content WHERE MessageID = @id";

                    using (SqlCommand cmd = new SqlCommand(query, conn))
                    {
                        cmd.Parameters.AddWithValue("@content", newContent);
                        cmd.Parameters.AddWithValue("@id", messageID);
                        cmd.ExecuteNonQuery();
                    }
                }
            }
            catch (SqlException sqlEx)
            {
                if (sqlEx.Message.Contains("Invalid object name 'Messages'"))
                {
                    _messagesTableExists = false;
                    try { EnsureMessagesTableExists(); } catch { }
                }
                Logger.Error("Lỗi cập nhật tin nhắn trong database", sqlEx);
            }
            catch (Exception ex)
            {
                Logger.Error("Lỗi cập nhật tin nhắn trong database", ex);
            }
        }

        // Lấy lịch sử chat giữa 2 người dùng
        public List<MessageData> GetChatHistory(string userID1, string userID2, int limit = 100)
        {
            var messages = new List<MessageData>();
            if (!_messagesTableExists || !_dbAvailable) return messages;

            using (SqlConnection conn = new SqlConnection(_connectionString))
            {
                try
                {
                    conn.Open();
                    string query = @"SELECT TOP (@limit) MessageID, SenderID, ReceiverID, MessageContent, MessageType, FileName, CreatedAt
                                     FROM Messages
                                     WHERE (SenderID = @user1 AND ReceiverID = @user2) 
                                        OR (SenderID = @user2 AND ReceiverID = @user1)
                                     ORDER BY CreatedAt DESC";

                    using (SqlCommand cmd = new SqlCommand(query, conn))
                    {
                        cmd.Parameters.AddWithValue("@user1", userID1);
                        cmd.Parameters.AddWithValue("@user2", userID2);
                        cmd.Parameters.AddWithValue("@limit", limit);

                        using (SqlDataReader reader = cmd.ExecuteReader())
                        {
                            while (reader.Read())
                            {
                                messages.Add(new MessageData
                                {
                                    MessageID = (int)reader["MessageID"],
                                    SenderID = reader["SenderID"].ToString(),
                                    ReceiverID = reader["ReceiverID"].ToString(),
                                    MessageContent = reader["MessageContent"]?.ToString(),
                                    MessageType = reader["MessageType"]?.ToString() ?? "Text",
                                    FileName = reader["FileName"]?.ToString(),
                                    CreatedAt = (DateTime)reader["CreatedAt"]
                                });
                            }
                        }
                    }
                    messages.Reverse();
                }
                catch (SqlException sqlEx)
                {
                    if (sqlEx.Message.Contains("Invalid object name 'Messages'"))
                    {
                        _messagesTableExists = false;
                        try { EnsureMessagesTableExists(); } catch { }
                        return new List<MessageData>();
                    }
                    Logger.Error("Lỗi lấy lịch sử chat", sqlEx);
                }
                catch (Exception ex)
                {
                    Logger.Error("Lỗi lấy lịch sử chat", ex);
                }
            }
            return messages;
        }

        // Lấy danh sách các user mà userID đã từng nhắn tin (dạng Username + DisplayName)
        public List<UserStatus> GetContacts(string userID)
        {
            var contacts = new List<UserStatus>();
            if (!_dbAvailable) return contacts; // no contacts if DB unreachable

            using (SqlConnection conn = new SqlConnection(_connectionString))
            {
                try
                {
                    conn.Open();
                    string query = @"
                        SELECT DISTINCT CASE WHEN SenderID = @u THEN ReceiverID ELSE SenderID END AS ContactID
                        FROM Messages
                        WHERE SenderID = @u OR ReceiverID = @u
                    ";

                    var contactIds = new List<string>();
                    using (SqlCommand cmd = new SqlCommand(query, conn))
                    {
                        cmd.Parameters.AddWithValue("@u", userID);
                        using (SqlDataReader reader = cmd.ExecuteReader())
                        {
                            while (reader.Read())
                            {
                                var id = reader["ContactID"]?.ToString();
                                if (!string.IsNullOrEmpty(id)) contactIds.Add(id);
                            }
                        }
                    }

                    if (contactIds.Count == 0) return contacts;

                    string inClause = string.Join(",", contactIds.ConvertAll(id => "'" + id.Replace("'", "''") + "'"));
                    string query2 = $@"
                        SELECT Username, DisplayName FROM Users WHERE Username IN ({inClause})
                    ";

                    using (SqlCommand cmd2 = new SqlCommand(query2, conn))
                    {
                        using (SqlDataReader reader = cmd2.ExecuteReader())
                        {
                            while (reader.Read())
                            {
                                string id = reader["Username"]?.ToString() ?? "";
                                string display = reader["DisplayName"]?.ToString() ?? id;
                                contacts.Add(new UserStatus { UserID = id, UserName = display, IsOnline = false });
                            }
                        }
                    }
                }
                catch (SqlException sqlEx)
                {
                    if (sqlEx.Message.Contains("Invalid object name 'Messages'"))
                    {
                        _messagesTableExists = false;
                        try { EnsureMessagesTableExists(); } catch { }
                        return new List<UserStatus>();
                    }
                    Logger.Error("Lỗi lấy danh sách contacts", sqlEx);
                }
                catch (Exception ex)
                {
                    Logger.Error("Lỗi lấy danh sách contacts", ex);
                }
            }
            return contacts;
        }
    }


    // Class nhỏ để chứa dữ liệu trả về
    public class UserData
    {
        public string? Username { get; set; }
        public string? DisplayName { get; set; }
    }

    // Class để chứa dữ liệu tin nhắn
    public class MessageData
    {
        public int MessageID { get; set; }
        public string? SenderID { get; set; }
        public string? ReceiverID { get; set; }
        public string? MessageContent { get; set; }
        public string MessageType { get; set; } = "Text";
        public string? FileName { get; set; }
        public DateTime CreatedAt { get; set; }
    }
}